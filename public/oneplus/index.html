<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ­ã‚°</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ½ï¸</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
<style>
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; font-family: 'Zen Maru Gothic', sans-serif; }
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .scrollbar-hide { scrollbar-width: none; -ms-overflow-style: none; }
  .backdrop-blur-sm { backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

const STORAGE_KEY = "menu-log-v3";
const F1 = "'Noto Serif JP', serif";
const F2 = "'Zen Maru Gothic', sans-serif";
const GR = "linear-gradient(135deg, #F59E0B, #D97706)";
const ALL_CAT = "__all__";
const NO_CAT = "ãã®ä»–";

// Storage wrapper using localStorage
const storage = {
  get: (key) => { try { const v = localStorage.getItem(key); return v ? { value: v } : null; } catch { return null; } },
  set: (key, value) => { try { localStorage.setItem(key, value); return true; } catch { return false; } },
  delete: (key) => { try { localStorage.removeItem(key); return true; } catch { return false; } },
};

const readFile = (f) => new Promise((r, e) => { const x = new FileReader(); x.onload = () => r(x.result); x.onerror = e; x.readAsDataURL(f); });
const shrink = (src, mW = 600) => new Promise((r) => {
  const i = new Image(); i.onload = () => { if (i.width <= mW) return r(src); const c = document.createElement("canvas"); const ra = mW / i.width; c.width = mW; c.height = Math.round(i.height * ra); const x = c.getContext("2d"); x.fillStyle = "#fff"; x.fillRect(0, 0, c.width, c.height); x.drawImage(i, 0, 0, c.width, c.height); r(c.toDataURL("image/jpeg", 0.75)); }; i.onerror = () => r(src); i.src = src;
});

const StarRating = ({ rating = 0, onRate, size = "text-2xl", interactive = true }) => {
  const [h, setH] = useState(0);
  return (<div style={{display:"flex",gap:"2px"}}>{[1,2,3,4,5].map(s => (
    <button key={s} type="button" disabled={!interactive} style={{fontSize: size === "text-lg" ? "18px" : "24px", cursor: interactive ? "pointer" : "default", background:"none", border:"none", padding:0, transition:"transform 0.1s"}}
      onMouseEnter={() => interactive && setH(s)} onMouseLeave={() => interactive && setH(0)} onClick={() => interactive && onRate(s)}>
      <span style={{ color: s <= (h || rating) ? "#F59E0B" : "#D1D5DB" }}>{s <= (h || rating) ? "â˜…" : "â˜†"}</span>
    </button>))}</div>);
};

const ShareButton = ({ item, rName }) => {
  const [ok, setOk] = useState(false);
  const go = async () => {
    const t = [`ğŸ½ï¸ ${rName}`,`ğŸ“‹ ${item.name}`,item.description&&`ğŸ“ ${item.description}`,item.price&&`ğŸ’° ${item.price}`,"â˜…".repeat(item.rating)+"â˜†".repeat(5-item.rating),item.comment&&`ğŸ’¬ ${item.comment}`,item.eatenDate&&`ğŸ“… ${item.eatenDate}`].filter(Boolean).join("\n");
    if (navigator.share) { try { await navigator.share({ title:`${rName} - ${item.name}`, text:t }); } catch{} } else { await navigator.clipboard.writeText(t); setOk(true); setTimeout(()=>setOk(false),2000); }
  };
  return <button onClick={go} style={{padding:"6px 12px",borderRadius:"9999px",fontSize:"12px",fontWeight:500,background:"#f1f5f9",color:"#475569",border:"none",cursor:"pointer"}}>{ok?"âœ“ ã‚³ãƒ”ãƒ¼æ¸ˆã¿":"â†— å…±æœ‰"}</button>;
};

const PhotoPicker = ({ photo, onChange, compact }) => {
  const cR = useRef(null), aR = useRef(null);
  const pk = async (e) => { const f = e.target.files?.[0]; if(!f) return; onChange(await shrink(await readFile(f))); e.target.value=""; };
  const bh = compact ? "80px" : "112px";
  const btnStyle = (hoverColor) => ({flex:1,height:bh,border:"2px dashed #cbd5e1",borderRadius:"8px",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",color:"#94a3b8",background:"none",cursor:"pointer",fontSize:"12px"});
  return (<div>
    <input ref={cR} type="file" accept="image/*" capture="environment" onChange={pk} style={{display:"none"}} />
    <input ref={aR} type="file" accept="image/*" onChange={pk} style={{display:"none"}} />
    {photo ? (<div style={{position:"relative"}}><img src={photo} alt="" style={{width:"100%",height:compact?"112px":"144px",objectFit:"cover",borderRadius:"8px"}} /><button onClick={()=>onChange(null)} style={{position:"absolute",top:4,right:4,background:"rgba(0,0,0,0.5)",color:"#fff",width:24,height:24,borderRadius:"50%",border:"none",fontSize:12,cursor:"pointer"}}>âœ•</button></div>
    ) : (<div style={{display:"flex",gap:"8px"}}>
      <button onClick={()=>cR.current?.click()} style={btnStyle()}><span style={{fontSize:compact?"18px":"24px"}}>ğŸ“¸</span><span>æ’®å½±</span></button>
      <button onClick={()=>aR.current?.click()} style={btnStyle()}><span style={{fontSize:compact?"18px":"24px"}}>ğŸ–¼ï¸</span><span>ã‚¢ãƒ«ãƒãƒ </span></button>
    </div>)}
  </div>);
};

const ImportModal = ({ isOpen, onClose, onImport }) => {
  const [text, setText] = useState("");
  const [err, setErr] = useState("");
  const tryImport = () => {
    setErr("");
    try {
      let c = text.trim();
      c = c.replace(/[\u201C\u201D\u201E\u201F\u2033\uFF02]/g, '"');
      c = c.replace(/[\u2018\u2019\u201A\u201B\u2032\uFF07]/g, "'");
      c = c.replace(/```json\s*/g,"").replace(/```/g,"").trim();
      const m = c.match(/\[[\s\S]*\]/); if (m) c = m[0];
      const arr = JSON.parse(c);
      if (!Array.isArray(arr) || !arr.length) throw new Error("ç©ºã®é…åˆ—");
      onImport(arr); setText(""); onClose();
    } catch (e) { setErr("JSONã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“: " + e.message); }
  };
  if (!isOpen) return null;
  return (
    <div onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.6)",zIndex:50,display:"flex",alignItems:"center",justifyContent:"center",padding:16}}>
      <div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:16,width:"100%",maxWidth:400,padding:20,maxHeight:"85vh",overflowY:"auto",boxShadow:"0 25px 50px rgba(0,0,0,0.25)"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
          <h3 style={{fontFamily:F1,fontSize:18,fontWeight:700,color:"#1e293b",margin:0}}>ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
          <button onClick={onClose} style={{background:"none",border:"none",color:"#94a3b8",fontSize:20,cursor:"pointer"}}>âœ•</button>
        </div>
        <div style={{background:"#fffbeb",border:"1px solid #fde68a",borderRadius:12,padding:12,marginBottom:16}}>
          <p style={{fontSize:12,color:"#92400e",fontWeight:600,marginBottom:8,fontFamily:F2}}>ä½¿ã„æ–¹</p>
          <ol style={{fontSize:12,color:"#b45309",margin:0,paddingLeft:0,listStyle:"none",fontFamily:F2}}>
            <li>1. Claudeã®ä¼šè©±ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†™çœŸã‚’é€ä¿¡</li>
            <li style={{marginTop:4}}>2.ã€Œã‚«ãƒ†ã‚´ãƒªä»˜ãJSONå½¢å¼ã§èª­ã¿å–ã£ã¦ã€ã¨ä¾é ¼</li>
            <li style={{marginTop:4}}>3. è¿”ã£ã¦ããŸJSONã‚’ã“ã“ã«ãƒšãƒ¼ã‚¹ãƒˆ</li>
          </ol>
        </div>
        <textarea value={text} onChange={e=>setText(e.target.value)} placeholder='[{"name":"...","category":"...","description":"...","price":"..."}]'
          style={{width:"100%",height:128,padding:"10px 12px",border:"1px solid #e2e8f0",borderRadius:12,fontSize:14,fontFamily:"monospace",resize:"none",boxSizing:"border-box"}} />
        {err && <p style={{color:"#ef4444",fontSize:12,marginTop:8}}>{err}</p>}
        <button onClick={tryImport} disabled={!text.trim()} style={{width:"100%",marginTop:12,padding:"12px 0",borderRadius:12,fontWeight:700,color:"#fff",border:"none",cursor:text.trim()?"pointer":"default",opacity:text.trim()?1:0.4,background:GR,fontSize:14}}>ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹</button>
      </div>
    </div>
  );
};

const AddItemForm = ({ onAdd, onClose, categories }) => {
  const blank = { name:"", category:"", description:"", price:"", photo:null, rating:0, comment:"", eatenDate:"", eaten:false };
  const [form, setForm] = useState(blank);
  const submit = () => { if(!form.name.trim()) return; onAdd({ ...form, id:Date.now().toString(), category:form.category||NO_CAT, eaten:form.rating>0||!!form.comment||!!form.eatenDate }); onClose(); };
  const inputStyle = {width:"100%",padding:"10px 12px",border:"1px solid #e2e8f0",borderRadius:8,fontSize:14,boxSizing:"border-box"};
  return (
    <div onClick={onClose} style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.6)",zIndex:50,display:"flex",alignItems:"flex-end",justifyContent:"center"}}>
      <div onClick={e=>e.stopPropagation()} style={{background:"#fff",borderRadius:"16px 16px 0 0",width:"100%",maxWidth:400,padding:20,maxHeight:"90vh",overflowY:"auto"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
          <h3 style={{fontFamily:F1,fontSize:18,fontWeight:700,color:"#1e293b",margin:0}}>â• ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ </h3>
          <button onClick={onClose} style={{background:"none",border:"none",color:"#94a3b8",fontSize:20,cursor:"pointer"}}>âœ•</button>
        </div>
        <div style={{display:"flex",flexDirection:"column",gap:12}}>
          <PhotoPicker photo={form.photo} onChange={p=>setForm({...form,photo:p})} compact />
          <input value={form.name} onChange={e=>setForm({...form,name:e.target.value})} placeholder="ãƒ¡ãƒ‹ãƒ¥ãƒ¼å *" style={inputStyle} />
          <div><input list="cat-list" value={form.category} onChange={e=>setForm({...form,category:e.target.value})} placeholder="ã‚«ãƒ†ã‚´ãƒªï¼ˆä¾‹: ã‚«ãƒ¬ãƒ¼ã€ãƒŠãƒ³ï¼‰" style={inputStyle} /><datalist id="cat-list">{categories.map(c=><option key={c} value={c} />)}</datalist></div>
          <input value={form.description} onChange={e=>setForm({...form,description:e.target.value})} placeholder="æ–™ç†ã®å†…å®¹" style={inputStyle} />
          <input value={form.price} onChange={e=>setForm({...form,price:e.target.value})} placeholder="ä¾¡æ ¼" style={inputStyle} />
          <div><label style={{fontSize:12,color:"#64748b",display:"block",marginBottom:4}}>ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</label><StarRating rating={form.rating} onRate={r=>setForm({...form,rating:r})} /></div>
          <input value={form.comment} onChange={e=>setForm({...form,comment:e.target.value})} placeholder="ä¸€è¨€æ„Ÿæƒ³" style={inputStyle} />
          <input type="date" value={form.eatenDate} onChange={e=>setForm({...form,eatenDate:e.target.value})} style={inputStyle} />
          <button onClick={submit} disabled={!form.name.trim()} style={{width:"100%",padding:"12px 0",borderRadius:12,fontWeight:700,color:"#fff",border:"none",cursor:form.name.trim()?"pointer":"default",opacity:form.name.trim()?1:0.4,background:GR,fontSize:14}}>è¿½åŠ ã™ã‚‹</button>
        </div>
      </div>
    </div>
  );
};

const MenuItemCard = ({ item, onUpdate, onDelete, rName }) => {
  const [editing, setEditing] = useState(false);
  const [form, setForm] = useState(item);
  const inputStyle = {width:"100%",padding:"8px 12px",border:"1px solid #e2e8f0",borderRadius:8,fontSize:14,boxSizing:"border-box"};
  const smallBtn = (onClick, label, color="#94a3b8") => <button onClick={onClick} style={{fontSize:12,color,background:"none",border:"none",cursor:"pointer",padding:"4px 8px"}}>{label}</button>;

  if (editing) {
    return (
      <div style={{background:"#fff",borderRadius:16,boxShadow:"0 4px 6px rgba(0,0,0,0.07)",border:"1px solid #f1f5f9",padding:16,display:"flex",flexDirection:"column",gap:12}}>
        <PhotoPicker photo={form.photo} onChange={p=>setForm({...form,photo:p})} compact />
        {[["name","ãƒ¡ãƒ‹ãƒ¥ãƒ¼å"],["description","æ–™ç†ã®å†…å®¹"],["price","ä¾¡æ ¼"]].map(([k,ph])=>(
          <input key={k} value={form[k]} onChange={e=>setForm({...form,[k]:e.target.value})} placeholder={ph} style={inputStyle} />
        ))}
        <div><label style={{fontSize:12,color:"#64748b",display:"block",marginBottom:4}}>ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</label><StarRating rating={form.rating} onRate={r=>setForm({...form,rating:r})} /></div>
        <input value={form.comment} onChange={e=>setForm({...form,comment:e.target.value})} placeholder="ä¸€è¨€æ„Ÿæƒ³" style={inputStyle} />
        <input type="date" value={form.eatenDate} onChange={e=>setForm({...form,eatenDate:e.target.value})} style={inputStyle} />
        <div style={{display:"flex",gap:8}}>
          <button onClick={()=>{onUpdate(form);setEditing(false);}} style={{flex:1,padding:"8px 0",borderRadius:8,fontWeight:700,color:"#fff",border:"none",cursor:"pointer",background:GR,fontSize:14}}>ä¿å­˜</button>
          <button onClick={()=>{setForm(item);setEditing(false);}} style={{flex:1,padding:"8px 0",borderRadius:8,fontWeight:500,color:"#475569",border:"none",cursor:"pointer",background:"#f1f5f9",fontSize:14}}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </div>
    );
  }
  return (
    <div style={{background:"#fff",borderRadius:16,boxShadow:"0 4px 6px rgba(0,0,0,0.07)",border:"1px solid #f1f5f9",overflow:"hidden"}}>
      {item.photo && <img src={item.photo} alt={item.name} style={{width:"100%",height:160,objectFit:"cover"}} />}
      <div style={{padding:16}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:4}}>
          <h4 style={{fontFamily:F1,fontWeight:700,color:"#1e293b",fontSize:16,margin:0}}>{item.name}</h4>
          {item.price && <span style={{color:"#d97706",fontWeight:700,fontSize:14,whiteSpace:"nowrap",marginLeft:8}}>{item.price}</span>}
        </div>
        {item.description && <p style={{fontSize:12,color:"#64748b",marginBottom:8,marginTop:0}}>{item.description}</p>}
        {item.eaten ? (
          <div>
            <div style={{display:"flex",alignItems:"center",gap:8,flexWrap:"wrap",marginBottom:8}}>
              <span style={{background:"#dcfce7",color:"#15803d",fontSize:12,padding:"2px 8px",borderRadius:9999,fontWeight:500}}>é£Ÿã¹ãŸï¼</span>
              {item.eatenDate && <span style={{fontSize:12,color:"#94a3b8"}}>{item.eatenDate}</span>}
            </div>
            <StarRating rating={item.rating} onRate={()=>{}} size="text-lg" interactive={false} />
            {item.comment && <p style={{fontSize:14,color:"#475569",background:"#f8fafc",borderRadius:8,padding:8,fontStyle:"italic",margin:"8px 0"}}>ã€Œ{item.comment}ã€</p>}
            <div style={{display:"flex",gap:8,paddingTop:4,flexWrap:"wrap"}}>
              <ShareButton item={item} rName={rName} />
              {smallBtn(()=>setEditing(true),"âœï¸ ç·¨é›†")}
              {smallBtn(()=>onDelete(item.id),"ğŸ—‘ï¸ å‰Šé™¤","#94a3b8")}
            </div>
          </div>
        ) : (
          <div>
            <span style={{background:"#f1f5f9",color:"#64748b",fontSize:12,padding:"2px 8px",borderRadius:9999,fontWeight:500}}>ã¾ã é£Ÿã¹ã¦ãªã„</span>
            <div style={{display:"flex",gap:8,paddingTop:8,flexWrap:"wrap"}}>
              <button onClick={()=>onUpdate({...item,eaten:true,eatenDate:new Date().toISOString().split("T")[0]})} style={{fontSize:12,fontWeight:500,color:"#d97706",padding:"6px 12px",background:"#fffbeb",borderRadius:9999,border:"none",cursor:"pointer"}}>ğŸ´ é£Ÿã¹ãŸï¼</button>
              {smallBtn(()=>setEditing(true),"âœï¸ ç·¨é›†")}
              {smallBtn(()=>onDelete(item.id),"ğŸ—‘ï¸ å‰Šé™¤","#94a3b8")}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

const RestaurantPhotos = ({ photos, onAdd, onRemove }) => {
  const cR=useRef(null), aR=useRef(null);
  const pk = async(e)=>{ for(const f of Array.from(e.target.files)) onAdd(await shrink(await readFile(f))); e.target.value=""; };
  return (
    <div style={{padding:"0 16px 16px"}}>
      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
        <h3 style={{fontFamily:F1,fontSize:14,fontWeight:700,color:"#334155",margin:0}}>ğŸ“· ãŠåº—ã®å†™çœŸ</h3>
        <div style={{display:"flex",gap:4}}>
          <input ref={cR} type="file" accept="image/*" capture="environment" onChange={pk} style={{display:"none"}} />
          <input ref={aR} type="file" accept="image/*" multiple onChange={pk} style={{display:"none"}} />
          <button onClick={()=>cR.current?.click()} style={{fontSize:12,color:"#d97706",padding:"4px 8px",background:"#fffbeb",borderRadius:9999,border:"none",cursor:"pointer"}}>ğŸ“¸ æ’®å½±</button>
          <button onClick={()=>aR.current?.click()} style={{fontSize:12,color:"#0284c7",padding:"4px 8px",background:"#f0f9ff",borderRadius:9999,border:"none",cursor:"pointer"}}>ğŸ–¼ï¸ è¿½åŠ </button>
        </div>
      </div>
      {photos.length > 0 ? (
        <div className="scrollbar-hide" style={{display:"flex",gap:8,overflowX:"auto",paddingBottom:4}}>{photos.map((p,i)=>(
          <div key={i} style={{position:"relative",flexShrink:0}}><img src={p} alt="" style={{width:112,height:80,objectFit:"cover",borderRadius:8}} />
            <button onClick={()=>onRemove(i)} style={{position:"absolute",top:2,right:2,background:"rgba(0,0,0,0.5)",color:"#fff",width:20,height:20,borderRadius:"50%",border:"none",fontSize:10,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}}>âœ•</button>
          </div>))}</div>
      ) : <p style={{fontSize:12,color:"#94a3b8",textAlign:"center",padding:"12px 0",fontFamily:F2}}>å¤–è¦³ã‚„å†…è£…ã®å†™çœŸã‚’è¿½åŠ </p>}
    </div>
  );
};

const CategoryTabs = ({ categories, active, onSelect, items }) => {
  const countFor = (cat) => cat === ALL_CAT ? items.length : items.filter(i => (i.category || NO_CAT) === cat).length;
  const eatenFor = (cat) => { const list = cat === ALL_CAT ? items : items.filter(i => (i.category || NO_CAT) === cat); return list.filter(i => i.eaten).length; };
  return (
    <div style={{padding:"0 16px 12px"}}>
      <div className="scrollbar-hide" style={{display:"flex",gap:6,overflowX:"auto",paddingBottom:4}}>
        {[ALL_CAT, ...categories].map(cat => {
          const isA = active === cat;
          return (
            <button key={cat} onClick={() => onSelect(cat)}
              style={{flexShrink:0,padding:"8px 12px",borderRadius:12,fontSize:12,fontWeight:500,whiteSpace:"nowrap",border:"none",cursor:"pointer",transition:"all 0.2s",fontFamily:F2,
                background:isA?"#f59e0b":"rgba(255,255,255,0.7)",color:isA?"#fff":"#475569",boxShadow:isA?"0 1px 3px rgba(0,0,0,0.1)":"none"}}>
              {cat === ALL_CAT ? "ã™ã¹ã¦" : cat}
              <span style={{marginLeft:4,color:isA?"rgba(255,255,255,0.7)":"#94a3b8"}}>{eatenFor(cat)}/{countFor(cat)}</span>
            </button>
          );
        })}
      </div>
    </div>
  );
};

function MenuLogApp() {
  const [rest, setRest] = useState({ name: "ãŠåº—ã®åå‰", icon: null, photos: [] });
  const [items, setItems] = useState([]);
  const [activeCat, setActiveCat] = useState(ALL_CAT);
  const [statusFilter, setStatusFilter] = useState("all");
  const [showImport, setShowImport] = useState(false);
  const [showAdd, setShowAdd] = useState(false);
  const [editName, setEditName] = useState(false);
  const [loaded, setLoaded] = useState(false);

  useEffect(() => { const r = storage.get(STORAGE_KEY); if(r?.value){try{const d=JSON.parse(r.value); if(d.rest) setRest(p=>({...p,...d.rest,photos:d.rest.photos||[]})); if(d.items) setItems(d.items);}catch{}} setLoaded(true); }, []);
  useEffect(() => { if(!loaded) return; storage.set(STORAGE_KEY, JSON.stringify({rest,items})); }, [rest, items, loaded]);

  const categories = [...new Set(items.map(i => i.category || NO_CAT))];
  const eaten = items.filter(i => i.eaten).length;
  const total = items.length;
  const catFiltered = activeCat === ALL_CAT ? items : items.filter(i => (i.category || NO_CAT) === activeCat);
  const shown = catFiltered.filter(i => statusFilter === "eaten" ? i.eaten : statusFilter === "notEaten" ? !i.eaten : true);

  const handleImport = (arr) => {
    const newItems = arr.map((d, i) => ({
      id: (Date.now() + i).toString(), name: d.name || "ä¸æ˜", category: d.category || NO_CAT,
      description: d.description || "", price: d.price || "",
      photo: null, rating: 0, comment: "", eatenDate: "", eaten: false,
    }));
    setItems(p => [...p, ...newItems]);
  };

  const handleReset = () => { if(confirm("ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")){ setRest({name:"ãŠåº—ã®åå‰",icon:null,photos:[]}); setItems([]); setActiveCat(ALL_CAT); storage.delete(STORAGE_KEY); }};

  const filterBtnStyle = (active) => ({flex:1,padding:"8px 0",borderRadius:8,fontSize:12,fontWeight:500,border:"none",cursor:"pointer",transition:"all 0.2s",fontFamily:F2,background:active?"#fff":"transparent",color:active?"#b45309":"#64748b",boxShadow:active?"0 1px 2px rgba(0,0,0,0.05)":"none"});

  return (
    <div style={{minHeight:"100vh",background:"linear-gradient(180deg, #FFFBEB 0%, #FEF3C7 30%, #FDE68A 100%)"}}>
      {/* Header */}
      <div style={{position:"relative",overflow:"hidden"}}>
        <div style={{padding:"32px 16px 24px",position:"relative"}}>
          <div style={{display:"flex",justifyContent:"center",marginBottom:12}}>
            <div style={{position:"relative",width:80,height:80,borderRadius:"50%",overflow:"hidden",border:"4px solid #fff",boxShadow:"0 4px 12px rgba(0,0,0,0.1)",background:"#fef3c7"}}>
              {rest.icon ? <img src={rest.icon} alt="" style={{width:"100%",height:"100%",objectFit:"cover"}} /> : <div style={{width:"100%",height:"100%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:30}}>ğŸ½ï¸</div>}
              <input type="file" accept="image/*" style={{position:"absolute",inset:0,opacity:0,cursor:"pointer"}}
                onChange={async(e)=>{const f=e.target.files?.[0]; if(f){const s=await shrink(await readFile(f),400); setRest(r=>({...r,icon:s}));}}} />
            </div>
          </div>
          {editName ? (
            <div style={{display:"flex",justifyContent:"center",gap:8,marginBottom:8}}>
              <input autoFocus value={rest.name} onChange={e=>setRest(r=>({...r,name:e.target.value}))} onKeyDown={e=>e.key==="Enter"&&setEditName(false)}
                style={{textAlign:"center",fontSize:20,fontWeight:700,background:"rgba(255,255,255,0.8)",borderRadius:8,padding:"4px 16px",border:"1px solid #fcd34d",fontFamily:F1}} />
              <button onClick={()=>setEditName(false)} style={{color:"#d97706",fontWeight:700,fontSize:18,background:"none",border:"none",cursor:"pointer"}}>âœ“</button>
            </div>
          ) : (
            <h1 onClick={()=>setEditName(true)} style={{fontSize:24,fontWeight:700,textAlign:"center",color:"#1e293b",cursor:"pointer",margin:"0 0 4px",fontFamily:F1}}>{rest.name}</h1>
          )}
          <p style={{textAlign:"center",fontSize:12,color:"#94a3b8",marginBottom:16,fontFamily:F2}}>ã‚¿ãƒƒãƒ—ã§åº—åãƒ»ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´</p>
          <div style={{display:"flex",justifyContent:"center",gap:24}}>
            {[["é£Ÿã¹ãŸ",eaten,"#d97706"],["æœªé£Ÿ",total-eaten,"#94a3b8"],["å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼",total,"#334155"]].map(([l,n,c])=>(
              <div key={l} style={{textAlign:"center"}}><div style={{fontSize:24,fontWeight:700,color:c}}>{n}</div><div style={{fontSize:12,color:"#64748b"}}>{l}</div></div>
            ))}
          </div>
          {total > 0 && (
            <div style={{marginTop:12,maxWidth:240,marginLeft:"auto",marginRight:"auto"}}>
              <div style={{height:8,background:"rgba(255,255,255,0.6)",borderRadius:9999,overflow:"hidden"}}>
                <div style={{height:"100%",borderRadius:9999,transition:"width 0.5s",width:`${(eaten/total)*100}%`,background:"linear-gradient(90deg, #F59E0B, #D97706)"}} />
              </div>
              <p style={{fontSize:12,textAlign:"center",color:"#64748b",marginTop:4}}>{Math.round((eaten/total)*100)}% åˆ¶è¦‡</p>
            </div>
          )}
        </div>
      </div>

      <RestaurantPhotos photos={rest.photos} onAdd={p=>setRest(r=>({...r,photos:[...r.photos,p]}))} onRemove={i=>setRest(r=>({...r,photos:r.photos.filter((_,j)=>j!==i)}))} />

      <div style={{padding:"0 16px 16px"}}>
        <div style={{display:"flex",gap:8}}>
          <button onClick={()=>setShowImport(true)} style={{flex:1,padding:"12px 0",borderRadius:12,fontWeight:700,color:"#fff",border:"none",cursor:"pointer",background:GR,fontSize:14,fontFamily:F2,boxShadow:"0 4px 6px rgba(0,0,0,0.1)"}}>ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
          <button onClick={()=>setShowAdd(true)} style={{padding:"12px 16px",borderRadius:12,fontWeight:700,color:"#b45309",background:"#fff",border:"1px solid #fde68a",cursor:"pointer",fontSize:14,fontFamily:F2,boxShadow:"0 4px 6px rgba(0,0,0,0.1)"}}>â• æ‰‹å‹•è¿½åŠ </button>
        </div>
      </div>

      {categories.length > 0 && <CategoryTabs categories={categories} active={activeCat} onSelect={setActiveCat} items={items} />}

      {items.length > 0 && (
        <div style={{padding:"0 16px 12px"}}>
          <div style={{display:"flex",gap:4,background:"rgba(255,255,255,0.6)",borderRadius:12,padding:4}}>
            {[["all",`ã™ã¹ã¦ (${catFiltered.length})`],["eaten",`é£Ÿã¹ãŸ (${catFiltered.filter(i=>i.eaten).length})`],["notEaten",`æœªé£Ÿ (${catFiltered.filter(i=>!i.eaten).length})`]].map(([k,l])=>(
              <button key={k} onClick={()=>setStatusFilter(k)} style={filterBtnStyle(statusFilter===k)}>{l}</button>
            ))}
          </div>
        </div>
      )}

      <div style={{padding:"0 16px 32px",display:"flex",flexDirection:"column",gap:12}}>
        {shown.length === 0 && total === 0 && (
          <div style={{textAlign:"center",padding:"64px 0"}}>
            <div style={{fontSize:48,marginBottom:16}}>ğŸœ</div>
            <p style={{color:"#64748b",fontSize:14,marginBottom:8,fontFamily:F2}}>ã¾ã ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p>
            <p style={{color:"#94a3b8",fontSize:12,lineHeight:1.6,fontFamily:F2}}>Claudeã®ä¼šè©±ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼å†™çœŸã‚’é€ã£ã¦<br/>JSONå½¢å¼ã§èª­ã¿å–ã£ã¦ã‚‚ã‚‰ã„ã€<br/>ã€ŒğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã‹ã‚‰ãƒšãƒ¼ã‚¹ãƒˆã—ã¾ã—ã‚‡ã†ï¼</p>
          </div>
        )}
        {shown.length === 0 && total > 0 && (
          <div style={{textAlign:"center",padding:"32px 0"}}><p style={{color:"#94a3b8",fontSize:14,fontFamily:F2}}>è©²å½“ã™ã‚‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</p></div>
        )}
        {shown.map(item => (
          <MenuItemCard key={item.id} item={item} rName={rest.name}
            onUpdate={u=>setItems(p=>p.map(i=>i.id===u.id?u:i))}
            onDelete={id=>setItems(p=>p.filter(i=>i.id!==id))} />
        ))}
      </div>

      {total > 0 && <div style={{padding:"0 16px 32px",textAlign:"center"}}><button onClick={handleReset} style={{fontSize:12,color:"#94a3b8",background:"none",border:"none",cursor:"pointer"}}>ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button></div>}

      <ImportModal isOpen={showImport} onClose={()=>setShowImport(false)} onImport={handleImport} />
      {showAdd && <AddItemForm onAdd={item=>setItems(p=>[...p,item])} onClose={()=>setShowAdd(false)} categories={categories} />}
    </div>
  );
}

ReactDOM.render(<MenuLogApp />, document.getElementById("root"));
</script>
</body>
</html>
